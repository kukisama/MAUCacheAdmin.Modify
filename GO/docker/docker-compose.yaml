services:
  # ---- Go 同步引擎：只管从 CDN 同步文件 ----
  sync:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - maucache:/data/maucache
    environment:
      - MAUCACHE_SYNC_CHANNEL=Production
      - MAUCACHE_SYNC_INTERVAL=6h
      - MAUCACHE_SYNC_CONCURRENCY=4
      - MAUCACHE_LOG_LEVEL=info
      - MAUCACHE_LOG_FORMAT=json
      - MAUCACHE_CACHE_DIR=/data/maucache
      - MAUCACHE_SCRATCH_DIR=/data/maucache/.tmp
      - MAUCACHE_HEALTH_LISTEN=:8080
      - TZ=Asia/Shanghai
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 60s
      timeout: 5s
      retries: 3

  # ---- Nginx：只管对外提供文件服务 ----
  web:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
    volumes:
      - maucache:/data/maucache:ro    # 只读挂载，Nginx 只需要读
      - logs:/data/logs               # Nginx 访问日志
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - sync
    restart: unless-stopped

volumes:
  maucache:   # 两个容器共享的缓存目录
  logs:       # 共享的日志目录
