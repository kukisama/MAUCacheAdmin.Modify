# MAUCacheAdmin PowerShell → Go 语言改造详细记录

> 记录日期：2026-02-16  
> 改造方向：将 PowerShell 模块改造为 Go 语言同步引擎 + Nginx 文件服务的容器化方案

---

## 1. 改造背景

### 1.1 现有方案

MAUCacheAdmin.Modify 是一个 PowerShell 工具集，用于管理 **Microsoft AutoUpdate (MAU)** 的本地缓存服务器。当前方案依赖：

- **Windows Server** + **IIS** 作为文件服务器
- **PowerShell 5.1+** 执行同步逻辑
- **Windows 计划任务** 或 **systemd timer** 做定时调度
- **手动执行** `PrepIISServer.ps1` 配置 IIS（MIME 类型、目录浏览等）

### 1.2 改造动机

| 痛点 | 描述 |
|------|------|
| IIS 依赖重 | 需要 Windows Server + IIS 角色 + MIME 类型配置 + 注册表操作 |
| 环境隔离差 | 脚本直接操作 `C:\inetpub\wwwroot\`，与宿主系统耦合 |
| 日志能力弱 | 依赖 IIS 日志模块，无法灵活查询和持久化 |
| 部署复杂 | 需要 `PrepIISServer.ps1` + `CreateScheduledTask.ps1` 多步配置 |
| 串行处理 | PowerShell 版本逐个应用串行处理，效率低 |

### 1.3 改造目标

**一个 Docker 镜像 + Nginx，`docker compose up -d` 一行命令即可完成「定时同步 CDN」+「对外提供文件服务」+「结构化访问日志」。**

---

## 2. 技术选型决策

| 组件 | 现有方案 | Go 方案 | 选型理由 |
|------|---------|---------|---------|
| 同步引擎 | PowerShell + System.Net.Http | Go 单二进制 | 无运行时依赖、交叉编译、原生并发、镜像 < 30MB |
| Web 服务器 | IIS | Nginx (独立容器) | 零配置静态文件、sendfile 大文件优化、原生访问日志 |
| 定时调度 | Windows 计划任务 / systemd | Go 内置 `time.Ticker` | 容器内无需外部调度器 |
| Plist 解析 | PowerShell ConvertFrom-Plist | Go `encoding/xml` | 标准库直接解析 |
| 日志系统 | IIS W3C 日志 | Go `log/slog` + Nginx JSON | Docker 原生日志，可对接 Loki/ELK |
| 配置管理 | 脚本参数硬编码 | 环境变量 + YAML | 容器最佳实践 |
| 部署架构 | 单容器(IIS+PS) | 双容器(Go sync + Nginx) | 关注点分离，独立升级 |

---

## 3. PowerShell → Go 函数对照表

### 3.1 公开函数 (Public)

| PowerShell 函数 | Go 文件 | Go 函数 | 改进点 |
|----------------|---------|---------|--------|
| `Get-MAUProductionBuilds` | `internal/cdn/builds.go` | `Client.FetchBuilds()` | 复用 HTTP 连接 (修复P5) |
| `Get-MAUApps` | `internal/cdn/apps.go` | `Client.FetchAllApps()` | 串行→并发获取 20 个应用 |
| `Get-MAUCacheDownloadJobs` | `internal/sync/planner.go` | `PlanDownloads()` | HEAD 请求可并发化 |
| `Invoke-MAUCacheDownload` | `internal/sync/downloader.go` | `ExecuteDownloads()` | errgroup 并发+原子 rename (修复P1,P8) |
| `Save-MAUCollaterals` | `internal/sync/collateral.go` | `SaveCollaterals(isProd=true)` | 统一函数 (修复P2,P9) |
| `Save-oldMAUCollaterals` | `internal/sync/collateral.go` | `SaveCollaterals(isProd=false)` | 合并为同一函数 |
| `Set-MAUCacheAdminHttpClientHandler` | `internal/cdn/client.go` | `NewClient()` 单例 | 不需要外部注入 |

### 3.2 私有函数 (Private)

| PowerShell 函数 | Go 对应 | 说明 |
|----------------|---------|------|
| `Get-MAUApp` | `cdn/apps.go: fetchOneApp()` | 获取单个应用清单 |
| `ConvertFrom-Plist` | `cdn/plist.go: parseDictToMap()` 等 | 递归解析器→声明式 XML 解析 |
| `ConvertFrom-AppPackageDictionary` | `cdn/plist.go: ParsePlistPackages()` | 内联合并 |
| `Get-PlistFromURI` | `cdn/client.go: GetString()+GetStringOptional()` | HTTP 获取+解析分离 |
| `Invoke-HttpClientDownload` | `cdn/client.go: Client.Download()` | 流式下载，修复 P1 |
| `Get-HttpClientHandler` | `cdn/client.go: NewClient()` | 全局单例 |
| `ConvertFrom-BytesToString` | 不需要 | Go 日志直接输出 int64 |
| `Utilities.ps1 (FixLineBreaks)` | `cdn/builds.go` | `strings.ReplaceAll("\r\n","\n")` 一行搞定 |

### 3.3 入口脚本

| PowerShell 文件 | Go 对应 | 说明 |
|----------------|---------|------|
| `MacUpdatesOffice.Modify.ps1` | `internal/sync/sync.go: Engine.RunOnce()` | 主流程编排 |
| `CreateScheduledTask.ps1` | `internal/sync/sync.go: Engine.RunLoop()` | 内建调度器 |
| `PrepIISServer.ps1` | `docker/nginx.conf` | **完全消除**，Nginx 配置文件替代 |

---

## 4. 已修复的问题

在改造过程中，修复了代码架构审查中发现的多个问题：

### P1: 异常静默吞噬 → 修复

**问题**: `Invoke-HttpClientDownload.ps1` 第 72-74 行 catch 块仅 `Write-Host` 不抛异常，导致下载失败被静默忽略。

**Go 修复**: `downloader.go` 中 `downloadOneFile` 函数在下载失败时返回 error，并记录结构化日志。重试逻辑真正生效。

### P2: CachePath 验证不一致 → 修复

**问题**: `Save-MAUCollaterals` 会自动创建目录，`Invoke-MAUCacheDownload` 对 CachePath 不存在时直接 throw。

**Go 修复**: 统一使用 `os.MkdirAll()` 自动创建所需目录。

### P4: 递归删除 collateral 文件 → 修复

**问题**: `MacUpdatesOffice.Modify.ps1` 使用 `-Recurse` 删除 `*.xml` 和 `*.cat`，会误删 `collateral/` 子目录下的编录文件。

**Go 修复**: `cleanup.go` 仅删除根目录下的 xml/cat 文件，不递归进入 collateral 子目录。

### P5: HttpClient 重复创建 → 修复

**问题**: 每个 PowerShell 函数都 `new HttpClient` → `Dispose`，可能导致 TCP 端口耗尽。

**Go 修复**: `Client` 结构体全局复用一个 `http.Client` 实例，内置连接池。

### P8: 重试逻辑缺陷 → 修复

**问题**: 重试只在 "The response ended prematurely" 时触发，且固定重试 2 次无退避。

**Go 修复**: 可配置重试次数（默认 3 次），使用指数退避策略。

### P9: URI 拼接使用字符串操作 → 修复

**问题**: `Save-MAUCollaterals.ps1` 使用 `LastIndexOf('/')` + `Substring` 手动切割 URI。

**Go 修复**: 使用 `url.Parse()` 标准库函数解析 URI，更安全可靠。

---

## 5. 新增功能

| 功能 | 说明 |
|------|------|
| 并发下载 | `errgroup` 限制并发数（默认 4），大幅提升同步速度 |
| 指数退避重试 | 下载失败后 2^n × 5s 退避，避免 CDN 限流 |
| 原子文件写入 | 先写 scratch 临时文件，完成后 `os.Rename` 到目标路径 |
| 健康检查 API | `/healthz` 和 `/sync/status` 端点，支持 Docker 健康检查 |
| 结构化日志 | JSON 格式日志输出到 stdout，支持 `docker logs` 和日志系统 |
| 环境变量配置 | 通过环境变量或 YAML 文件配置，符合容器最佳实践 |
| 优雅退出 | 监听 SIGINT/SIGTERM，确保清理资源后安全退出 |

---

## 6. 文件清单

### 6.1 Go 源代码

```
GO/
├── cmd/maucache/
│   └── main.go              # 入口：CLI 参数解析 + 启动同步引擎
├── internal/
│   ├── config/
│   │   └── config.go        # 配置：环境变量 + YAML，对应 PS 的 param 块
│   ├── cdn/
│   │   ├── client.go        # HTTP 客户端：复用连接，对应 Invoke-HttpClientDownload
│   │   ├── builds.go        # FetchBuilds：对应 Get-MAUProductionBuilds
│   │   ├── apps.go          # FetchAllApps：对应 Get-MAUApps + Get-MAUApp
│   │   ├── plist.go         # Plist 解析：对应 ConvertFrom-Plist
│   │   └── plist_test.go    # Plist 解析单元测试
│   ├── sync/
│   │   ├── sync.go          # 主流程编排：对应 MacUpdatesOffice.Modify.ps1
│   │   ├── planner.go       # 下载计划：对应 Get-MAUCacheDownloadJobs
│   │   ├── downloader.go    # 并发下载：对应 Invoke-MAUCacheDownload
│   │   ├── collateral.go    # 编录保存：对应 Save-MAUCollaterals + Save-oldMAUCollaterals
│   │   └── cleanup.go       # 文件清理：对应 主脚本的删除逻辑
│   ├── health/
│   │   └── health.go        # 健康检查：/healthz + /sync/status（新增功能）
│   └── logging/
│       └── logging.go       # 结构化日志：JSON/Text 格式（新增功能）
├── go.mod                   # Go 模块定义
└── go.sum                   # 依赖校验

```

### 6.2 容器部署文件

```
GO/docker/
├── Dockerfile               # 多阶段构建，最终镜像 ~25MB
├── docker-compose.yaml      # 双容器编排（sync + nginx）
└── nginx.conf               # Nginx 配置（替代 PrepIISServer.ps1）
```

### 6.3 文档

```
GO/
├── 详细记录.md               # 本文件：改造详细记录
├── go架构设计.md             # Go 架构设计文档
└── GO语言重置.md             # 原始参考文档（已有）
```

---

## 7. 代码量对比

| 指标 | PowerShell | Go |
|------|-----------|-----|
| 源文件数 | 19 个 .ps1 | 13 个 .go |
| 核心代码行 | ~600 行 | ~750 行 |
| 测试文件 | 1 个 (PSScriptAnalyzer 规则检查) | 1 个 (Plist 解析单元测试) |
| 外部依赖 | System.Net.Http | golang.org/x/sync, gopkg.in/yaml.v3 |
| 部署配置 | 3 个脚本 (IIS+计划任务+主脚本) | 3 个文件 (Dockerfile+compose+nginx.conf) |

---

## 8. 部署方式

### 8.1 Docker 部署（推荐）

```bash
cd GO/docker/
docker compose build
docker compose up -d
```

### 8.2 离线部署（镜像导出导入）

```bash
# 在能上网的机器上
docker compose build
docker save maucache-sync:latest -o maucache-sync.tar
docker save nginx:1.27-alpine -o nginx.tar

# 在内网服务器上
docker load -i maucache-sync.tar
docker load -i nginx.tar
docker compose up -d
```

### 8.3 直接运行（不用 Docker）

```bash
cd GO/
go build -o maucache-sync ./cmd/maucache
./maucache-sync --once  # 单次同步
./maucache-sync         # 定时循环
```

### 8.4 配置说明

通过环境变量配置：

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `MAUCACHE_SYNC_CHANNEL` | Production | 更新频道 |
| `MAUCACHE_SYNC_INTERVAL` | 6h | 同步间隔 |
| `MAUCACHE_SYNC_CONCURRENCY` | 4 | 并发下载数 |
| `MAUCACHE_SYNC_RETRY_MAX` | 3 | 最大重试次数 |
| `MAUCACHE_CACHE_DIR` | /data/maucache | 缓存目录 |
| `MAUCACHE_SCRATCH_DIR` | /data/maucache/.tmp | 临时目录 |
| `MAUCACHE_LOG_LEVEL` | info | 日志级别 |
| `MAUCACHE_LOG_FORMAT` | json | 日志格式 |
| `MAUCACHE_HEALTH_LISTEN` | :8080 | 健康检查端口 |

---

## 9. 运维操作

```bash
# 查看同步日志
docker compose logs -f sync

# 查看 Nginx 访问日志（谁在下载什么）
docker compose logs -f web | jq .

# 检查同步状态
curl http://localhost:8080/sync/status

# 健康检查
curl http://localhost:8080/healthz

# 手动触发一次同步
docker compose exec sync maucache --once

# 单独重启 Nginx（不影响同步）
docker compose restart web

# 查看缓存大小
docker compose exec web du -sh /data/maucache
```

---

## 10. 功能复刻验证报告

> 验证日期：2026-02-16  
> 验证方法：逐函数对比 PowerShell 与 Go 代码 + 单元测试验证

### 10.1 总体结论

**Go 代码已基本完整复刻了 PowerShell 的核心功能**，同时在并发、重试、日志等方面做了显著改进。以下为逐项详细对比结果。

### 10.2 逐函数对比验证

#### ✅ 已完整复刻的功能

| # | PowerShell 函数 | Go 对应 | 验证结果 | 单元测试 |
|---|----------------|---------|---------|---------|
| 1 | `Get-MAUProductionBuilds` | `cdn.FetchBuilds()` | ✅ 完全一致：同一 CDN URL、相同的换行处理逻辑 | `plist_test.go` |
| 2 | `Get-MAUApps` | `cdn.FetchAllApps()` | ✅ 20个应用ID完全一致，频道GUID完全一致 | `apps_test.go` |
| 3 | `Get-MAUApp` | `cdn.fetchOneApp()` | ✅ 获取 AppXML/ChkXml/HistoryXML 逻辑一致，version=99999 修复一致 | `apps_test.go` |
| 4 | `ConvertFrom-Plist` | `cdn.parseDictToMap()` 等 | ✅ 支持 dict/array/string/integer/true/false 节点 | `plist_test.go` |
| 5 | `ConvertFrom-AppPackageDictionary` | `cdn.ParsePlistPackages()` | ✅ 提取 Location/BinaryUpdaterLocation/FullUpdaterLocation | `plist_test.go` |
| 6 | `Get-PlistObjectFromURI` | `cdn.GetString()` + `GetStringOptional()` | ✅ 分离为两个方法，Optional 处理 404/400 | — |
| 7 | `Invoke-HttpClientDownload` | `cdn.Download()` | ✅ 256KB 缓冲区一致，流式下载 | — |
| 8 | `Get-HttpClientHandler` | `cdn.NewClient()` | ✅ 全局复用，修复 P5 端口耗尽问题 | — |
| 9 | `Save-MAUCollaterals` (isProd=true) | `sync.SaveCollaterals(isProd=true)` | ✅ 保存 5 个 URI（AppXML, CAT, ChkXml, 版本化CAT, 版本化XML） | — |
| 10 | `Save-oldMAUCollaterals` | `sync.SaveCollaterals(isProd=false)` | ✅ 保存到 collateral/{version}/ 下 3 个文件 | — |
| 11 | `Get-MAUCacheDownloadJobs` 核心逻辑 | `sync.PlanDownloads()` | ✅ HEAD 请求、大小比对、delta 过滤 | `planner_test.go` |
| 12 | `Invoke-MAUCacheDownload` 核心逻辑 | `sync.ExecuteDownloads()` | ✅ 缓存验证、scratch写入→rename、LastModified设置 | — |
| 13 | 主脚本清理逻辑 | `sync.Cleanup()` | ✅ 废弃文件删除 + xml/cat 清理（修复 P4 不递归） | `cleanup_test.go` |
| 14 | `MacUpdatesOffice.Modify.ps1` 流程编排 | `sync.Engine.RunOnce()` | ✅ 清理→获取版本→获取应用→保存编录→下载 | — |
| 15 | `CreateScheduledTask.ps1` | `sync.Engine.RunLoop()` | ✅ 内建定时循环，无需外部调度 | — |
| 16 | `PrepIISServer.ps1` | `docker/nginx.conf` | ✅ MIME 类型、目录浏览完全替代 | — |
| 17 | `FixLineBreaks` (Utilities.ps1) | `strings.ReplaceAll("\r\n","\n")` | ✅ 一行代码替代 | — |
| 18 | `ConvertFrom-BytesToString` | Go 日志直接输出数字 | ✅ 不需要该函数，日志输出 size_bytes/size_mb | — |

#### ⚠️ 有差异但不影响核心功能

| # | 差异点 | PowerShell | Go | 影响评估 |
|---|--------|-----------|-----|---------|
| 1 | `-Mirror` 开关 | 支持删除缓存中多余文件 | 未实现 | 低：可手动清理 |
| 2 | `-CompareLastModified` | 可选的时间戳比对验证 | 仅在下载后设置时间戳 | 低：大小比对已足够 |
| 3 | `-IncludeHistoricVersions` | 可选包含历史版本全量包 | 未实现 | 低：生产环境通常不需要 |
| 4 | `-IncludeHistoricDeltas` | 可选包含历史 delta 包 | 未实现 | 低：同上 |
| 5 | `-DeltaToBuildLimiter` | 支持按目标版本过滤 | 仅支持按来源版本过滤 | 低：主脚本未使用此参数 |
| 6 | 进度条 (Write-Progress) | 有详细的下载进度条 | 日志替代（无交互式进度） | 低：容器环境不需要进度条 |

#### 🆕 Go 新增的功能（PowerShell 不具备）

| 功能 | 说明 |
|------|------|
| 并发下载 | `errgroup` 限制并发数（默认 4），大幅提升同步速度 |
| 指数退避重试 | 可配置次数 + 2^n 退避，修复 PS 固定 2 次重试问题 |
| 原子文件写入 | 先写 .tmp/ 再 os.Rename，避免 Nginx 读到半成品文件 |
| 健康检查 API | `/healthz` + `/sync/status`，Docker 原生健康检查 |
| 结构化日志 | JSON/Text 格式，含配置生效、下载详情、速度、时长等 |
| 环境变量 + YAML | 灵活配置，符合 12-Factor App |
| 优雅退出 | 监听 SIGINT/SIGTERM，安全清理 |

### 10.3 单元测试验证清单

通过 `go test ./...` 运行的 30+ 个单元测试：

```
✅ TestTargetAppsCount            — 确认 20 个应用
✅ TestTargetAppsIDs              — 逐一比对 PS 的 AppID
✅ TestChannelPathsGUIDs          — 验证 3 个频道 GUID
✅ TestBuildVersionedURI          — 版本化 URI 构建
✅ TestChannelBaseURL             — 频道基础 URL
✅ TestParsePlistPackages         — Plist 包解析（Location/Version）
✅ TestParsePlistVersion          — 版本号解析
✅ TestParsePlistStringArray      — 历史版本数组解析
✅ TestParsePlistBooleanValues    — 布尔值处理
✅ TestParsePlistEmptyInput       — 空输入处理
✅ TestDefaultValues              — 10 个默认配置值
✅ TestEnvOverrides               — 环境变量覆盖
✅ TestYAMLFileLoading            — YAML 配置加载
✅ TestEnvTakesPriorityOverYAML   — 配置优先级
✅ TestInvalidEnvFallsBackToDefaults — 无效值回退
✅ TestDeprecatedFileDeletion     — 废弃文件删除
✅ TestXmlCatFilesInRootDeleted   — 根目录 xml/cat 清理
✅ TestCollateralSubdirNotDeleted — P4 修复验证
✅ TestBuildsTxtDeleted           — builds.txt 清理
✅ TestNonMatchingFilesNotDeleted — .pkg 文件保留
✅ TestCleanupEmptyDir            — 空目录安全
✅ TestUniqueStrings              — 去重（5 个子用例）
✅ TestDeltaPatternMatching       — delta 正则（4 个子用例）
✅ TestDeltaFilteringWithBuilds   — builds 过滤
✅ TestNonDeltaAlwaysKept         — 非 delta 保留
✅ TestNewLoggerLevels            — 日志级别（5 个子用例）
✅ TestNewLoggerFormats           — JSON/Text 格式
✅ TestNewTrackerNonNil           — 健康追踪器
✅ TestSetRunning/TestRecordSync  — 状态追踪
✅ TestHealthzEndpoint            — 健康检查端点
✅ TestSyncStatusEndpoint         — 同步状态端点
✅ TestServeContextCancellation   — 优雅退出
```

---

## 11. ManifestServer / CDN URL 是否写死

### 11.1 结论：CDN 基础 URL 是写死的，但产品清单是动态获取的

#### 写死的部分

```go
// builds.go
const cdnBase = "https://officecdnmac.microsoft.com"

// apps.go
var channelPaths = map[string]string{
    "Production": "/pr/C1297A47-86C4-4C1F-97FA-950631F94777/MacAutoupdate/",
    "Preview":    "/pr/1ac37578-5a24-40fb-892e-b89d85b6dfaa/MacAutoupdate/",
    "Beta":       "/pr/4B2D7701-0A4F-49C8-B4CB-0C2D4043F51F/MacAutoupdate/",
}
```

这与 PowerShell 版本完全一致（`Get-MAUApps.ps1` 第 17-21 行）。两者都将 CDN 域名和频道 GUID 硬编码在代码中。

#### 动态获取的部分

以下数据每次同步时从 CDN **实时获取**，不是写死的：

| 数据 | 来源 URL | 说明 |
|------|---------|------|
| 构建版本列表 | `{cdnBase}/{channel}/builds.txt` | 每次同步实时下载 |
| 应用包清单 | `{cdnBase}/{channel}/{AppID}.xml` | 20 个应用各自获取 |
| 版本检查信息 | `{cdnBase}/{channel}/{AppID}-chk.xml` | 实时获取最新版本号 |
| 历史版本列表 | `{cdnBase}/{channel}/{AppID}-history.xml` | 可选，实时获取 |
| 下载 URL | 从 AppID.xml 的 Plist 中解析 | URL 完全由微软 CDN 动态提供 |

#### 风险评估

如果微软更改了 CDN 域名（`officecdnmac.microsoft.com`）或频道 GUID，需要更新代码。但这种情况极罕见——自 MAU 存在以来这些值就未变化过。PowerShell 原版也是同样的硬编码策略。

### 11.2 ManifestServer 说明

`config_profile_examples/` 中的 plist 文件定义的 `ManifestServer` 是部署在内网的缓存服务器地址（即本项目部署后的地址），与 Go 代码中的 CDN URL 是不同层面的概念：

- **Go 代码中的 CDN URL**：从微软官方 CDN 拉取数据（上游）
- **ManifestServer plist 配置**：Mac 客户端连接内网缓存服务器（下游）

两者的关系是：Go 同步引擎从上游 CDN 拉取文件 → 存储到本地 → Nginx 对外提供服务 → Mac 客户端通过 ManifestServer 配置连接 Nginx。

---

## 12. 容器配置持久化验证

### 12.1 结论：✅ 容器配置可以持久化，重启后生效

#### 配置持久化机制

**方式1：环境变量（docker-compose.yaml）**

```yaml
# docker-compose.yaml 中定义的环境变量在容器重启后自动生效
environment:
  - MAUCACHE_SYNC_CHANNEL=Production
  - MAUCACHE_SYNC_INTERVAL=6h
  - MAUCACHE_SYNC_CONCURRENCY=4
  - MAUCACHE_LOG_LEVEL=info
  - MAUCACHE_LOG_FORMAT=json
```

`docker compose restart sync` 后，环境变量配置自动恢复。修改 `docker-compose.yaml` 后执行 `docker compose up -d` 即可应用新配置。

**方式2：YAML 配置文件（挂载 volume）**

在 `docker-compose.yaml` 中添加配置文件挂载：

```yaml
services:
  sync:
    volumes:
      - maucache:/data/maucache
      - ./config.yaml:/etc/maucache/config.yaml:ro  # 挂载配置文件
    command: ["--config", "/etc/maucache/config.yaml"]
```

配置文件存储在宿主机上，容器重启后自动读取。

#### 数据持久化

```yaml
volumes:
  maucache:   # Docker named volume，容器重建后数据保留
  logs:       # Nginx 日志持久化
```

Docker named volumes 在 `docker compose down` 时不会删除（需要 `docker compose down -v` 才会删除），因此：

- ✅ `docker compose restart` → 配置和数据都保留
- ✅ `docker compose down && docker compose up -d` → 数据保留，配置从 yaml/env 重新加载
- ⚠️ `docker compose down -v` → 数据和 volume 一起删除

#### Dockerfile VOLUME 声明

```dockerfile
VOLUME ["/data/maucache"]
```

确保即使不使用 docker-compose，直接 `docker run` 时也会创建匿名 volume 持久化缓存数据。

---

## 13. 独立运行能力验证

### 13.1 结论：✅ Go 代码可以完全独立运行，不依赖 web 服务器

#### 独立运行方式

```bash
# 方式1：编译后直接运行
cd GO/
go build -o maucache-sync ./cmd/maucache
./maucache-sync --once          # 单次同步
./maucache-sync                 # 定时循环

# 方式2：通过环境变量自定义配置
MAUCACHE_CACHE_DIR=/tmp/mycache \
MAUCACHE_LOG_FORMAT=text \
MAUCACHE_LOG_LEVEL=debug \
./maucache-sync --once

# 方式3：使用 YAML 配置文件
./maucache-sync --config config.yaml --once
```

#### 独立性分析

| 组件 | 是否依赖 | 说明 |
|------|---------|------|
| Nginx (web 容器) | ❌ 不依赖 | Go 引擎独立完成同步，Nginx 只负责对外提供文件服务 |
| Docker | ❌ 不依赖 | 可编译为单二进制直接运行 |
| IIS | ❌ 不依赖 | 完全替代 |
| 外部调度器 | ❌ 不依赖 | 内建 `time.Ticker` 定时循环 |
| 外部数据库 | ❌ 不依赖 | 文件系统存储 |
| 网络访问 | ✅ 需要 | 需要访问 `officecdnmac.microsoft.com` |

Go 同步引擎自身具备完整能力：
1. **定义配置**：通过环境变量、YAML 文件或代码默认值
2. **缓存文件**：下载和管理 .pkg/.xml/.cat 文件到本地目录
3. **检查缓存状态**：HEAD 请求比对文件大小，决定是否需要重新下载
4. **健康检查**：内建 HTTP API（:8080），提供 `/healthz` 和 `/sync/status`

如果不需要对外提供文件服务（例如仅做数据同步），完全不需要 Nginx 容器。

---

## 14. 日志系统完善性验证

### 14.1 已有日志覆盖（增强后）

| 阶段 | 日志内容 | 日志级别 |
|------|---------|---------|
| **启动** | 配置来源、所有生效配置值（频道/间隔/并发数/目录/日志级别等） | INFO |
| **清理** | 删除文件数量、耗时 | INFO |
| **获取版本** | builds.txt 版本数量、耗时 | INFO |
| **获取应用** | 每个应用处理进度、应用总数、耗时 | INFO |
| **获取应用失败** | 失败的应用名和错误信息 | WARN |
| **历史版本** | 历史版本数量 | DEBUG |
| **保存编录** | 模式（当前/历史）、应用数、保存/失败计数 | INFO |
| **下载计划** | 总任务数、需下载数、跳过数、总大小、耗时 | INFO |
| **缓存验证** | 文件不存在/大小不匹配/缓存有效 | DEBUG |
| **开始下载** | 应用名、文件名、大小(bytes/MB)、URL | INFO |
| **下载完成** | 文件名、大小、耗时、速度(MB/s) | INFO |
| **下载重试** | 文件名、重试次数、最大次数、退避时长、上次错误 | WARN |
| **下载失败** | 文件名、总尝试次数、耗时、错误详情 | ERROR |
| **大小不匹配** | 预期大小 vs 实际大小 | WARN |
| **同步完成** | 状态（成功/部分失败）、下载/跳过/失败数、下载耗时、总耗时 | INFO |
| **定时触发** | 触发时间、下次同步时间 | INFO |
| **退出信号** | 收到信号通知 | INFO |
| **Health API** | 启动地址 | INFO |

### 14.2 日志输出示例

```json
{"time":"2026-02-16T08:00:00Z","level":"INFO","msg":"配置加载完成","config_source":"环境变量/默认值","channel":"Production","interval":"6h0m0s","concurrency":4,"cache_dir":"/data/maucache"}
{"time":"2026-02-16T08:00:00Z","level":"INFO","msg":"Health API 启动","addr":":8080"}
{"time":"2026-02-16T08:00:00Z","level":"INFO","msg":"同步引擎启动，进入定时循环模式","interval":"6h0m0s","channel":"Production"}
{"time":"2026-02-16T08:00:00Z","level":"INFO","msg":"===== 开始同步 =====","channel":"Production","cache_dir":"/data/maucache","concurrency":4}
{"time":"2026-02-16T08:00:01Z","level":"INFO","msg":"步骤1: 清理完成","deleted":15,"duration":"120ms"}
{"time":"2026-02-16T08:00:02Z","level":"INFO","msg":"步骤2: 构建版本获取完成","count":8,"duration":"856ms"}
{"time":"2026-02-16T08:00:30Z","level":"INFO","msg":"步骤3: 应用信息获取完成","count":20,"duration":"28s"}
{"time":"2026-02-16T08:01:00Z","level":"INFO","msg":"步骤4: 编录文件保存完成","duration":"30s"}
{"time":"2026-02-16T08:01:15Z","level":"INFO","msg":"步骤5-6: 下载计划生成完成","total_jobs":127,"need_download":5,"skip":122,"total_size_mb":"2048.50","duration":"15s"}
{"time":"2026-02-16T08:01:15Z","level":"INFO","msg":"开始执行下载","total_jobs":127,"need_download":5,"cache_valid":122,"concurrency":4}
{"time":"2026-02-16T08:01:15Z","level":"INFO","msg":"开始下载","app":"Word 365/2021/2019","file":"Microsoft_Word_16.93_Updater.pkg","size_bytes":1048576000,"size_mb":"1000.00","url":"https://..."}
{"time":"2026-02-16T08:05:30Z","level":"INFO","msg":"下载完成","file":"Microsoft_Word_16.93_Updater.pkg","size_mb":"1000.00","duration":"4m15s","speed_mbps":"3.92"}
{"time":"2026-02-16T08:10:00Z","level":"INFO","msg":"===== 同步完成 =====","status":"成功","downloaded":5,"skipped":122,"failed":0,"download_duration":"8m45s","total_duration":"10m0s"}
{"time":"2026-02-16T08:10:00Z","level":"INFO","msg":"下次同步时间","next":"2026-02-16T14:10:00+08:00"}
```

### 14.3 排错日志示例

```json
{"time":"...","level":"WARN","msg":"重试下载","file":"xxx.pkg","attempt":2,"max_retry":3,"backoff":"10s","last_error":"connection reset"}
{"time":"...","level":"WARN","msg":"下载尝试失败","file":"xxx.pkg","attempt":2,"error":"connection reset by peer"}
{"time":"...","level":"ERROR","msg":"下载最终失败","file":"xxx.pkg","total_attempts":3,"duration":"35s","error":"重试 3 次后仍失败: connection reset"}
{"time":"...","level":"WARN","msg":"下载文件大小不匹配","file":"xxx.pkg","expected_bytes":1048576000,"actual_bytes":524288000}
{"time":"...","level":"WARN","msg":"HEAD 请求失败，跳过此文件","app":"Edge","file":"xxx.pkg","uri":"https://...","error":"timeout"}
{"time":"...","level":"WARN","msg":"存在下载失败的文件，请检查日志中的错误信息","failed_count":2}
```

---

## 15. 变更记录

### 15.1 变更概述

> 变更日期：2026-02-16 ~ 2026-02-17  
> 变更分支：`copilot/check-go-code-functionality`  
> 变更目的：功能复刻验证、日志系统增强、单元测试补充、Bug 修复

本次变更主要完成以下工作：

1. **功能复刻验证**：逐函数对比 PowerShell 与 Go 代码，确认 18 个核心功能已完整复刻
2. **单元测试补充**：新增 6 个测试文件，30+ 个测试用例，覆盖 config/cleanup/planner/apps/logging/health 模块
3. **日志系统增强**：补充配置生效日志、下载详情日志（大小/时长/速度）、步骤耗时、重试详情等
4. **配置系统增强**：新增 `LogEffective()` 方法，启动时输出所有生效配置
5. **Bug 修复**：修复下载速度计算的除零风险

### 15.2 变更文件清单

#### 新增文件

| 文件路径 | 说明 |
|---------|------|
| `GO/internal/config/config_test.go` | 配置模块单元测试（默认值、环境变量覆盖、YAML 加载、优先级、无效值回退） |
| `GO/internal/sync/cleanup_test.go` | 文件清理模块单元测试（废弃文件删除、P4 修复验证、xml/cat 清理） |
| `GO/internal/sync/planner_test.go` | 下载计划模块单元测试（去重、delta 正则匹配、builds 过滤） |
| `GO/internal/cdn/apps_test.go` | CDN 应用模块单元测试（20 个 AppID 逐一比对、频道 GUID、URI 构建） |
| `GO/internal/logging/logging_test.go` | 日志模块单元测试（日志级别、JSON/Text 格式） |
| `GO/internal/health/health_test.go` | 健康检查模块单元测试（端点响应、状态追踪、优雅退出） |

#### 修改文件

| 文件路径 | 变更内容 |
|---------|---------|
| `GO/cmd/maucache/main.go` | 启动时调用 `cfg.LogEffective()` 记录所有生效配置值 |
| `GO/internal/config/config.go` | 新增 `LogEffective()` 方法，返回当前生效配置的 map（含配置来源标识） |
| `GO/internal/sync/sync.go` | 增强同步流程日志：每步记录耗时、下载计划统计（need_download/skip/total_size_mb）、同步结果状态（成功/部分失败）、定时触发和下次同步时间 |
| `GO/internal/sync/downloader.go` | 增强下载日志（size_bytes/size_mb/URL/speed_mbps/duration）、重试详情（attempt/max_retry/backoff/last_error）、下载文件大小验证、**修复除零 Bug** |
| `GO/internal/sync/collateral.go` | 增强编录保存日志：模式标记（当前/历史）、saved/failed 计数 |
| `GO/internal/sync/planner.go` | 增强缓存验证日志：区分不存在/大小不匹配/缓存有效三种情况，HEAD 失败时记录完整信息 |
| `GO/详细记录.md` | 追加第 10-15 章：功能复刻验证报告、CDN URL 分析、容器持久化验证、独立运行验证、日志系统验证、变更记录 |

### 15.3 详细变更内容

#### 15.3.1 单元测试补充（6 个测试文件）

| 测试文件 | 测试数 | 覆盖范围 |
|---------|-------|---------|
| `config_test.go` | 5 | `TestDefaultValues` 验证 10 个默认配置值；`TestEnvOverrides` 验证环境变量覆盖；`TestYAMLFileLoading` 验证 YAML 配置加载；`TestEnvTakesPriorityOverYAML` 验证配置优先级；`TestInvalidEnvFallsBackToDefaults` 验证无效值回退 |
| `cleanup_test.go` | 6 | `TestDeprecatedFileDeletion` 废弃文件删除（Lync/Teams/wdav）；`TestXmlCatFilesInRootDeleted` 根目录 xml/cat 清理；`TestCollateralSubdirNotDeleted` **P4 修复验证**（collateral 子目录不递归删除）；`TestBuildsTxtDeleted`；`TestNonMatchingFilesNotDeleted` .pkg 文件保留；`TestCleanupEmptyDir` 空目录安全 |
| `planner_test.go` | 5 | `TestUniqueStrings` 去重（5 个子用例）；`TestUniqueStringsPreservesOrder` 顺序保持；`TestDeltaPatternMatching` delta 正则匹配（4 个子用例）；`TestDeltaFilteringWithBuilds` builds 过滤；`TestNonDeltaAlwaysKept` 非 delta 保留 |
| `apps_test.go` | 6 | `TestTargetAppsCount` 确认 20 个应用；`TestTargetAppsIDs` 逐一比对 PowerShell 的 AppID；`TestChannelPathsGUIDs` 验证 3 个频道 GUID；`TestBuildVersionedURIConstructsCorrectURIs` 版本化 URI 构建；`TestChannelBaseURL` 频道基础 URL；`TestChannelBaseURLUnknown` 未知频道处理 |
| `logging_test.go` | 4 | `TestNewLoggerLevels` 日志级别（debug/info/warn/error/unknown 5 个子用例）；`TestNewLoggerFormats` JSON/Text 格式；`TestNewLoggerDebugEnabled` debug 级别启用验证；`TestNewLoggerInfoDoesNotEnableDebug` 级别过滤 |
| `health_test.go` | 6 | `TestNewTrackerNonNil` 创建非空追踪器；`TestSetRunning` 运行状态设置；`TestRecordSync` 同步结果记录；`TestHealthzEndpoint` `/healthz` 返回 200+ok；`TestSyncStatusEndpoint` `/sync/status` 返回完整 JSON；`TestServeContextCancellation` 优雅退出 |

#### 15.3.2 日志系统增强

**启动阶段日志** (`main.go` + `config.go`)：

```go
// config.go 新增 LogEffective() 方法
func (c *Config) LogEffective(cfgPath string) map[string]interface{} {
    source := "环境变量/默认值"
    if cfgPath != "" {
        source = "YAML 文件: " + cfgPath
    }
    return map[string]interface{}{
        "config_source": source,
        "channel":       c.Sync.Channel,
        "interval":      c.Sync.Interval.String(),
        // ... 共 11 个配置项
    }
}

// main.go 启动时记录
cfgInfo := cfg.LogEffective(*cfgPath)
log.Info("配置加载完成", "config_source", cfgInfo["config_source"], ...)
```

**同步流程日志** (`sync.go`)：

- 每个步骤独立计时（`cleanStart`、`buildStart`、`appStart`、`collStart`、`planStart`、`dlStart`）
- 下载计划统计：`need_download`、`skip`、`total_size_mb`
- 同步结果状态：`"成功"` 或 `"部分失败"`
- 定时模式：记录 `trigger_time` 和 `next` 同步时间

**下载详情日志** (`downloader.go`)：

- 开始时记录：`size_bytes`、`size_mb`、`url`
- 完成时记录：`duration`（毫秒精度）、`speed_mbps`
- 重试时记录：`attempt`、`max_retry`、`backoff`、`last_error`
- 失败时记录：`total_attempts`、`duration`（秒精度）
- 新增下载后文件大小验证日志

**编录保存日志** (`collateral.go`)：

- 开始时记录模式（当前版本/历史版本）和应用数
- 完成时记录 `saved` 和 `failed` 计数
- 每个应用的 Debug 日志含 `version`、`saved`、`total_uris`

**下载计划日志** (`planner.go`)：

- 缓存不存在 → `"本地缓存不存在，需要下载"`
- 大小不匹配 → `"本地缓存大小不匹配"` 含 `local_size` 和 `remote_size`
- 缓存有效 → `"本地缓存有效"`
- HEAD 失败 → 记录 `app`、`file`、`uri`、`error`

#### 15.3.3 Bug 修复：除零保护

**文件**: `GO/internal/sync/downloader.go` 第 179-183 行

**问题**: 当下载在极短时间内完成（`dlDuration.Seconds()` 为 0）时，计算下载速度 `sizeMB / dlDuration.Seconds()` 会触发浮点除零。

**修复**:

```go
// 修复前
speedMBps := sizeMB / dlDuration.Seconds()

// 修复后
speedMBps := 0.0
if dlDuration.Seconds() > 0 {
    speedMBps = sizeMB / dlDuration.Seconds()
}
```

### 15.4 测试验证

所有 30+ 个测试通过 `go test ./...` 验证通过：

```
ok      maucache/internal/cdn       0.004s
ok      maucache/internal/config    0.003s
ok      maucache/internal/health    0.105s
ok      maucache/internal/logging   0.002s
ok      maucache/internal/sync      0.004s
```

### 15.5 安全审查

- **CodeQL 扫描**: 0 alerts，无安全漏洞
- **依赖检查**: 无新增外部依赖
