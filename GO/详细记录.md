# MAUCacheAdmin PowerShell → Go 语言改造详细记录

> 记录日期：2026-02-16  
> 改造方向：将 PowerShell 模块改造为 Go 语言同步引擎 + Nginx 文件服务的容器化方案

---

## 1. 改造背景

### 1.1 现有方案

MAUCacheAdmin.Modify 是一个 PowerShell 工具集，用于管理 **Microsoft AutoUpdate (MAU)** 的本地缓存服务器。当前方案依赖：

- **Windows Server** + **IIS** 作为文件服务器
- **PowerShell 5.1+** 执行同步逻辑
- **Windows 计划任务** 或 **systemd timer** 做定时调度
- **手动执行** `PrepIISServer.ps1` 配置 IIS（MIME 类型、目录浏览等）

### 1.2 改造动机

| 痛点 | 描述 |
|------|------|
| IIS 依赖重 | 需要 Windows Server + IIS 角色 + MIME 类型配置 + 注册表操作 |
| 环境隔离差 | 脚本直接操作 `C:\inetpub\wwwroot\`，与宿主系统耦合 |
| 日志能力弱 | 依赖 IIS 日志模块，无法灵活查询和持久化 |
| 部署复杂 | 需要 `PrepIISServer.ps1` + `CreateScheduledTask.ps1` 多步配置 |
| 串行处理 | PowerShell 版本逐个应用串行处理，效率低 |

### 1.3 改造目标

**一个 Docker 镜像 + Nginx，`docker compose up -d` 一行命令即可完成「定时同步 CDN」+「对外提供文件服务」+「结构化访问日志」。**

---

## 2. 技术选型决策

| 组件 | 现有方案 | Go 方案 | 选型理由 |
|------|---------|---------|---------|
| 同步引擎 | PowerShell + System.Net.Http | Go 单二进制 | 无运行时依赖、交叉编译、原生并发、镜像 < 30MB |
| Web 服务器 | IIS | Nginx (独立容器) | 零配置静态文件、sendfile 大文件优化、原生访问日志 |
| 定时调度 | Windows 计划任务 / systemd | Go 内置 `time.Ticker` | 容器内无需外部调度器 |
| Plist 解析 | PowerShell ConvertFrom-Plist | Go `encoding/xml` | 标准库直接解析 |
| 日志系统 | IIS W3C 日志 | Go `log/slog` + Nginx JSON | Docker 原生日志，可对接 Loki/ELK |
| 配置管理 | 脚本参数硬编码 | 环境变量 + YAML | 容器最佳实践 |
| 部署架构 | 单容器(IIS+PS) | 双容器(Go sync + Nginx) | 关注点分离，独立升级 |

---

## 3. PowerShell → Go 函数对照表

### 3.1 公开函数 (Public)

| PowerShell 函数 | Go 文件 | Go 函数 | 改进点 |
|----------------|---------|---------|--------|
| `Get-MAUProductionBuilds` | `internal/cdn/builds.go` | `Client.FetchBuilds()` | 复用 HTTP 连接 (修复P5) |
| `Get-MAUApps` | `internal/cdn/apps.go` | `Client.FetchAllApps()` | 串行→并发获取 20 个应用 |
| `Get-MAUCacheDownloadJobs` | `internal/sync/planner.go` | `PlanDownloads()` | HEAD 请求可并发化 |
| `Invoke-MAUCacheDownload` | `internal/sync/downloader.go` | `ExecuteDownloads()` | errgroup 并发+原子 rename (修复P1,P8) |
| `Save-MAUCollaterals` | `internal/sync/collateral.go` | `SaveCollaterals(isProd=true)` | 统一函数 (修复P2,P9) |
| `Save-oldMAUCollaterals` | `internal/sync/collateral.go` | `SaveCollaterals(isProd=false)` | 合并为同一函数 |
| `Set-MAUCacheAdminHttpClientHandler` | `internal/cdn/client.go` | `NewClient()` 单例 | 不需要外部注入 |

### 3.2 私有函数 (Private)

| PowerShell 函数 | Go 对应 | 说明 |
|----------------|---------|------|
| `Get-MAUApp` | `cdn/apps.go: fetchOneApp()` | 获取单个应用清单 |
| `ConvertFrom-Plist` | `cdn/plist.go: parseDictToMap()` 等 | 递归解析器→声明式 XML 解析 |
| `ConvertFrom-AppPackageDictionary` | `cdn/plist.go: ParsePlistPackages()` | 内联合并 |
| `Get-PlistFromURI` | `cdn/client.go: GetString()+GetStringOptional()` | HTTP 获取+解析分离 |
| `Invoke-HttpClientDownload` | `cdn/client.go: Client.Download()` | 流式下载，修复 P1 |
| `Get-HttpClientHandler` | `cdn/client.go: NewClient()` | 全局单例 |
| `ConvertFrom-BytesToString` | 不需要 | Go 日志直接输出 int64 |
| `Utilities.ps1 (FixLineBreaks)` | `cdn/builds.go` | `strings.ReplaceAll("\r\n","\n")` 一行搞定 |

### 3.3 入口脚本

| PowerShell 文件 | Go 对应 | 说明 |
|----------------|---------|------|
| `MacUpdatesOffice.Modify.ps1` | `internal/sync/sync.go: Engine.RunOnce()` | 主流程编排 |
| `CreateScheduledTask.ps1` | `internal/sync/sync.go: Engine.RunLoop()` | 内建调度器 |
| `PrepIISServer.ps1` | `docker/nginx.conf` | **完全消除**，Nginx 配置文件替代 |

---

## 4. 已修复的问题

在改造过程中，修复了代码架构审查中发现的多个问题：

### P1: 异常静默吞噬 → 修复

**问题**: `Invoke-HttpClientDownload.ps1` 第 72-74 行 catch 块仅 `Write-Host` 不抛异常，导致下载失败被静默忽略。

**Go 修复**: `downloader.go` 中 `downloadOneFile` 函数在下载失败时返回 error，并记录结构化日志。重试逻辑真正生效。

### P2: CachePath 验证不一致 → 修复

**问题**: `Save-MAUCollaterals` 会自动创建目录，`Invoke-MAUCacheDownload` 对 CachePath 不存在时直接 throw。

**Go 修复**: 统一使用 `os.MkdirAll()` 自动创建所需目录。

### P4: 递归删除 collateral 文件 → 修复

**问题**: `MacUpdatesOffice.Modify.ps1` 使用 `-Recurse` 删除 `*.xml` 和 `*.cat`，会误删 `collateral/` 子目录下的编录文件。

**Go 修复**: `cleanup.go` 仅删除根目录下的 xml/cat 文件，不递归进入 collateral 子目录。

### P5: HttpClient 重复创建 → 修复

**问题**: 每个 PowerShell 函数都 `new HttpClient` → `Dispose`，可能导致 TCP 端口耗尽。

**Go 修复**: `Client` 结构体全局复用一个 `http.Client` 实例，内置连接池。

### P8: 重试逻辑缺陷 → 修复

**问题**: 重试只在 "The response ended prematurely" 时触发，且固定重试 2 次无退避。

**Go 修复**: 可配置重试次数（默认 3 次），使用指数退避策略。

### P9: URI 拼接使用字符串操作 → 修复

**问题**: `Save-MAUCollaterals.ps1` 使用 `LastIndexOf('/')` + `Substring` 手动切割 URI。

**Go 修复**: 使用 `url.Parse()` 标准库函数解析 URI，更安全可靠。

---

## 5. 新增功能

| 功能 | 说明 |
|------|------|
| 并发下载 | `errgroup` 限制并发数（默认 4），大幅提升同步速度 |
| 指数退避重试 | 下载失败后 2^n × 5s 退避，避免 CDN 限流 |
| 原子文件写入 | 先写 scratch 临时文件，完成后 `os.Rename` 到目标路径 |
| 健康检查 API | `/healthz` 和 `/sync/status` 端点，支持 Docker 健康检查 |
| 结构化日志 | JSON 格式日志输出到 stdout，支持 `docker logs` 和日志系统 |
| 环境变量配置 | 通过环境变量或 YAML 文件配置，符合容器最佳实践 |
| 优雅退出 | 监听 SIGINT/SIGTERM，确保清理资源后安全退出 |

---

## 6. 文件清单

### 6.1 Go 源代码

```
GO/
├── cmd/maucache/
│   └── main.go              # 入口：CLI 参数解析 + 启动同步引擎
├── internal/
│   ├── config/
│   │   └── config.go        # 配置：环境变量 + YAML，对应 PS 的 param 块
│   ├── cdn/
│   │   ├── client.go        # HTTP 客户端：复用连接，对应 Invoke-HttpClientDownload
│   │   ├── builds.go        # FetchBuilds：对应 Get-MAUProductionBuilds
│   │   ├── apps.go          # FetchAllApps：对应 Get-MAUApps + Get-MAUApp
│   │   ├── plist.go         # Plist 解析：对应 ConvertFrom-Plist
│   │   └── plist_test.go    # Plist 解析单元测试
│   ├── sync/
│   │   ├── sync.go          # 主流程编排：对应 MacUpdatesOffice.Modify.ps1
│   │   ├── planner.go       # 下载计划：对应 Get-MAUCacheDownloadJobs
│   │   ├── downloader.go    # 并发下载：对应 Invoke-MAUCacheDownload
│   │   ├── collateral.go    # 编录保存：对应 Save-MAUCollaterals + Save-oldMAUCollaterals
│   │   └── cleanup.go       # 文件清理：对应 主脚本的删除逻辑
│   ├── health/
│   │   └── health.go        # 健康检查：/healthz + /sync/status（新增功能）
│   └── logging/
│       └── logging.go       # 结构化日志：JSON/Text 格式（新增功能）
├── go.mod                   # Go 模块定义
└── go.sum                   # 依赖校验

```

### 6.2 容器部署文件

```
GO/docker/
├── Dockerfile               # 多阶段构建，最终镜像 ~25MB
├── docker-compose.yaml      # 双容器编排（sync + nginx）
└── nginx.conf               # Nginx 配置（替代 PrepIISServer.ps1）
```

### 6.3 文档

```
GO/
├── 详细记录.md               # 本文件：改造详细记录
├── go架构设计.md             # Go 架构设计文档
└── GO语言重置.md             # 原始参考文档（已有）
```

---

## 7. 代码量对比

| 指标 | PowerShell | Go |
|------|-----------|-----|
| 源文件数 | 19 个 .ps1 | 13 个 .go |
| 核心代码行 | ~600 行 | ~750 行 |
| 测试文件 | 1 个 (PSScriptAnalyzer 规则检查) | 1 个 (Plist 解析单元测试) |
| 外部依赖 | System.Net.Http | golang.org/x/sync, gopkg.in/yaml.v3 |
| 部署配置 | 3 个脚本 (IIS+计划任务+主脚本) | 3 个文件 (Dockerfile+compose+nginx.conf) |

---

## 8. 部署方式

### 8.1 Docker 部署（推荐）

```bash
cd GO/docker/
docker compose build
docker compose up -d
```

### 8.2 离线部署（镜像导出导入）

```bash
# 在能上网的机器上
docker compose build
docker save maucache-sync:latest -o maucache-sync.tar
docker save nginx:1.27-alpine -o nginx.tar

# 在内网服务器上
docker load -i maucache-sync.tar
docker load -i nginx.tar
docker compose up -d
```

### 8.3 直接运行（不用 Docker）

```bash
cd GO/
go build -o maucache-sync ./cmd/maucache
./maucache-sync --once  # 单次同步
./maucache-sync         # 定时循环
```

### 8.4 配置说明

通过环境变量配置：

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `MAUCACHE_SYNC_CHANNEL` | Production | 更新频道 |
| `MAUCACHE_SYNC_INTERVAL` | 6h | 同步间隔 |
| `MAUCACHE_SYNC_CONCURRENCY` | 4 | 并发下载数 |
| `MAUCACHE_SYNC_RETRY_MAX` | 3 | 最大重试次数 |
| `MAUCACHE_CACHE_DIR` | /data/maucache | 缓存目录 |
| `MAUCACHE_SCRATCH_DIR` | /data/maucache/.tmp | 临时目录 |
| `MAUCACHE_LOG_LEVEL` | info | 日志级别 |
| `MAUCACHE_LOG_FORMAT` | json | 日志格式 |
| `MAUCACHE_HEALTH_LISTEN` | :8080 | 健康检查端口 |

---

## 9. 运维操作

```bash
# 查看同步日志
docker compose logs -f sync

# 查看 Nginx 访问日志（谁在下载什么）
docker compose logs -f web | jq .

# 检查同步状态
curl http://localhost:8080/sync/status

# 健康检查
curl http://localhost:8080/healthz

# 手动触发一次同步
docker compose exec sync maucache --once

# 单独重启 Nginx（不影响同步）
docker compose restart web

# 查看缓存大小
docker compose exec web du -sh /data/maucache
```
